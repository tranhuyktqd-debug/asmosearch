<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç H·ªÜ TH·ªêNG TRA C·ª®U TH√îNG TIN H·ªåC SINH</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .sheet-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .sheet-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .results-table {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f5f5f5;
            cursor: pointer;
        }
        
        .info-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .info-item {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .info-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .info-cert {
            font-size: 18px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .qrcode-container {
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .qrcode-container img {
            max-width: 220px;
            height: auto;
        }
        
        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç H·ªÜ TH·ªêNG TRA C·ª®U TH√îNG TIN H·ªåC SINH</h1>
    </div>
    
    <div class="container">
        <!-- Upload File Section -->
        <div class="section">
            <div class="section-title">üìÇ CH·ªåN FILE D·ªÆ LI·ªÜU</div>
            <div class="form-group">
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>
            <button class="btn btn-primary" onclick="readFile()">üìñ ƒê·ªçc file</button>
            <div id="sheetSelection" style="display: none; margin-top: 15px;">
                <div class="section-title">üìë Ch·ªçn sheet:</div>
                <div id="sheetCheckboxes" class="sheet-checkboxes"></div>
                <button class="btn btn-success" onclick="loadSheets()" style="margin-top: 10px;">‚úÖ Load d·ªØ li·ªáu t·ª´ sheet ƒë√£ ch·ªçn</button>
            </div>
        </div>
        
        <!-- Search Section -->
        <div class="section">
            <div class="section-title">üîç T√åM KI·∫æM</div>
            <div class="search-form">
                <div class="form-group">
                    <label>SBD:</label>
                    <input type="text" id="sbdInput" placeholder="Nh·∫≠p SBD">
                </div>
                <div class="form-group">
                    <label>H·ªç t√™n:</label>
                    <input type="text" id="hotenInput" placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                <div class="form-group">
                    <label>Ng√†y:</label>
                    <select id="daySelect">
                        <option value="">--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Th√°ng:</label>
                    <select id="monthSelect">
                        <option value="">--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>NƒÉm:</label>
                    <select id="yearSelect">
                        <option value="">--</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="searchStudents()">üîç T√åM KI·∫æM</button>
                <button class="btn btn-secondary" onclick="clearSearch()">üîÑ X√ìA B·ªò L·ªåC</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-container">
            <div class="section results-table">
                <div class="section-title">üìã K·∫æT QU·∫¢ T√åM KI·∫æM</div>
                <div id="resultsTable"></div>
            </div>
            
            <div class="info-panel">
                <div class="section-title">üë§ TH√îNG TIN CHI TI·∫æT</div>
                <div class="info-item">
                    <div class="info-label">H·ªç t√™n</div>
                    <div class="info-value" id="infoName">(Ch∆∞a ch·ªçn)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">S·ªë b√°o danh</div>
                    <div class="info-value" id="infoSBD">(Ch∆∞a ch·ªçn)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">M√£ Cert</div>
                    <div class="info-cert" id="infoCert">(Ch∆∞a ch·ªçn)</div>
                </div>
                <div class="qrcode-container" id="qrcodeContainer">
                    <div style="color: #7f8c8d;">(Ch∆∞a ch·ªçn)</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentStudents = [];
        let selectedSheets = [];
        let fileData = null;
        
        // Initialize dropdowns
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            document.getElementById('daySelect').appendChild(option);
        }
        
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            document.getElementById('monthSelect').appendChild(option);
        }
        
        for (let i = 2020; i >= 1990; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.text = i;
            document.getElementById('yearSelect').appendChild(option);
        }
        
        async function readFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui l√≤ng ch·ªçn file!');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    fileData = file;
                    displaySheets(data.sheets);
                } else {
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        function displaySheets(sheets) {
            const container = document.getElementById('sheetCheckboxes');
            container.innerHTML = '';
            
            sheets.forEach(sheet => {
                const div = document.createElement('div');
                div.className = 'sheet-checkbox';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = sheet;
                checkbox.id = 'sheet_' + sheet;
                if (sheet === 'TRAO GI·∫¢I' || sheets.indexOf(sheet) === 0) {
                    checkbox.checked = true;
                }
                const label = document.createElement('label');
                label.htmlFor = 'sheet_' + sheet;
                label.textContent = sheet;
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
            
            document.getElementById('sheetSelection').style.display = 'block';
        }
        
        async function loadSheets() {
            const checkboxes = document.querySelectorAll('#sheetCheckboxes input[type="checkbox"]');
            selectedSheets = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selectedSheets.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 sheet!');
                return;
            }
            
            if (!fileData) {
                alert('Vui l√≤ng ch·ªçn file tr∆∞·ªõc!');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileData);
            formData.append('sheets', JSON.stringify(selectedSheets));
            
            try {
                const response = await fetch('/api/load-sheets', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentStudents = data.students;
                    displayResults(currentStudents);
                    alert(`ƒê√£ load ${data.total} h·ªçc sinh!`);
                } else {
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        async function searchStudents() {
            const sbd = document.getElementById('sbdInput').value;
            const hoten = document.getElementById('hotenInput').value;
            const day = document.getElementById('daySelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sbd, hoten, day, month, year })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentStudents = data.students;
                    displayResults(currentStudents);
                } else {
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        function displayResults(students) {
            const container = document.getElementById('resultsTable');
            
            if (students.length === 0) {
                container.innerHTML = '<div class="loading">Kh√¥ng c√≥ k·∫øt qu·∫£</div>';
                return;
            }
            
            let html = '<table><thead><tr>';
            html += '<th>SBD</th><th>H·ªå T√äN</th><th>NG√ÄY SINH</th><th>KH·ªêI</th><th>TR∆Ø·ªúNG</th><th>CERT</th>';
            html += '</tr></thead><tbody>';
            
            students.forEach((student, index) => {
                html += `<tr onclick="selectStudent(${index})">`;
                html += `<td>${student.SBD || ''}</td>`;
                html += `<td>${student['FULL NAME'] || student['H·ªç t√™n'] || student['H·ªå T√äN'] || ''}</td>`;
                html += `<td>${student['Ng√†y sinh'] || student['NG√ÄY SINH'] || ''}</td>`;
                html += `<td>${student.KH·ªêI || ''}</td>`;
                html += `<td>${student.TR∆Ø·ªúNG || ''}</td>`;
                html += `<td>${student['M√É CERT'] || student['M√É CERT ƒê·∫¶Y ƒê·ª¶'] || ''}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function selectStudent(index) {
            const student = currentStudents[index];
            
            document.getElementById('infoName').textContent = student['FULL NAME'] || student['H·ªç t√™n'] || student['H·ªå T√äN'] || '(Kh√¥ng c√≥)';
            document.getElementById('infoSBD').textContent = student.SBD || '(Kh√¥ng c√≥)';
            document.getElementById('infoCert').textContent = student['M√É CERT'] || student['M√É CERT ƒê·∫¶Y ƒê·ª¶'] || '(Kh√¥ng c√≥)';
            
            // Load QR code
            const sbd = student.SBD;
            if (sbd) {
                try {
                    const response = await fetch(`/api/qrcode/${sbd}`);
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('qrcodeContainer').innerHTML = 
                            `<img src="${data.qrcode}" alt="QR Code">`;
                    } else {
                        document.getElementById('qrcodeContainer').innerHTML = 
                            '<div style="color: #7f8c8d;">(Kh√¥ng c√≥ QR)</div>';
                    }
                } catch (error) {
                    document.getElementById('qrcodeContainer').innerHTML = 
                        '<div style="color: #7f8c8d;">(Kh√¥ng c√≥ QR)</div>';
                }
            } else {
                document.getElementById('qrcodeContainer').innerHTML = 
                    '<div style="color: #7f8c8d;">(Kh√¥ng c√≥ SBD)</div>';
            }
        }
        
        function clearSearch() {
            document.getElementById('sbdInput').value = '';
            document.getElementById('hotenInput').value = '';
            document.getElementById('daySelect').value = '';
            document.getElementById('monthSelect').value = '';
            document.getElementById('yearSelect').value = '';
            
            if (currentStudents.length > 0) {
                displayResults(currentStudents);
            }
        }
    </script>
</body>
</html>
